<VirtualHost *:{% if env.ssl %}{{ env.ssl_port }}{% else %}80{% endif %}>
    ServerName {{ env.apache_server_name }}
    {% if env.apache_server_aliases %}ServerAlias {{ env.apache_server_aliases }}{% endif %}
    DocumentRoot {{ env.apache_docroot }}
    ServerAdmin {{ env.apache_server_admin_email }}
    RewriteEngine On
    AllowEncodedSlashes On

    Alias /media/ {{ env.apache_docroot }}/media
    Alias /static/ {{ env.apache_docroot }}/static

    {% if env.ssl %}
        SSLEngine On{% for cert_type, cert_file in env.apache_cert_files %}
        {{ cert_type }} {{ env.apache_dir }}/{{ cert_file }}{% endfor %}
        SSLProtocol all
        SSLCipherSuite HIGH:MEDIUM
        SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown
    {% endif %}

    <Directory {{ env.apache_docroot }}>
        Options FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>

    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>

    <Location /server-status>
        SetHandler server-status
        Order Deny,Allow
        Deny from all
        Allow from 127.0.0.1
    </Location>

    LogLevel warn
    ErrorLog {{ env.apache_log_dir }}/{{ env.apache_application_name }}-error.log
    CustomLog {{ env.apache_log_dir }}/{{ env.apache_application_name }}-access.log combined

    RewriteEngine On
    RewriteLog {{ env.apache_log_dir }}/{{ env.apache_application_name }}-rewrite.log
    RewriteLogLevel 0

    RewriteCond %{DOCUMENT_ROOT}/maintenance.html -f
    RewriteCond %{SCRIPT_FILENAME} !maintenance.html
    RewriteRule ^.*$ /maintenance.html [L]
    
    {% if env.apache_enforce_subdomain %}
        # Redirect domain.com to www.domain.com.
        RewriteCond %{HTTP_HOST} ^{{ env.apache_server_name }}(.*)$ [NC]
        RewriteCond %{HTTPS}s ^on(s)|
        RewriteRule ^(.*)$ http%1://www.{{ env.apache_server_name }}$1 [R=301,L]
    {% endif %}
    
    {{ env.apache_extra_rewrite_rules|safe }}

    WSGIDaemonProcess {{ env.apache_server_name }}{% if env.ssl %}-secure{% endif %} python-path={{ env.virtual_env_dir }}/lib/python{{ env.python_version }}/site-packages processes={{ env.apache_wsgi_processes }} threads={{ env.apache_wsgi_threads }} display-name=%{GROUP} user=apache group=apache
    WSGIProcessGroup {{ env.apache_server_name }}{% if env.ssl %}-secure{% endif %}
    WSGIScriptAlias / {{ env.apache_wsgi_path }}

    <Directory {{ env.wsgi_dir }}>
        Order allow,deny
        Allow from all
    </Directory>
    
</VirtualHost>